<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Resume Builder Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Шрифты -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:ital,wght@0,700;1,600&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:#0f111a;
      --card:#1f2337;
      --text:#f0f2fa;
      --muted:#8a94b0;
      --radius:14px;
      --shadow:0 30px 80px -10px rgba(15,17,26,.55);
      --accent:#6366f1;
      --transition:.35s cubic-bezier(.25,.8,.25,1);
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background: linear-gradient(135deg,#0f111a 0%,#1d223e 70%);
      color: var(--text);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      padding-bottom:60px;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem 1rem 3rem;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:2rem;
    }
    h1 {font-size:2rem; margin:0 0 .5rem; font-weight:700;}
    h2 {font-size:1.1rem; margin:0 0 .5rem; font-weight:600; text-transform:uppercase; letter-spacing:1px;}
    p {margin:0 0 1rem;}
    .panel {
      background: var(--card);
      border-radius: var(--radius);
      padding:1.5rem 1.75rem;
      position:relative;
      overflow:visible;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:1rem;
      transition: var(--transition);
    }
    .flex {display:flex; gap:1rem; flex-wrap:wrap;}
    .btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      border:none;
      padding:.75rem 1.4rem;
      border-radius:10px;
      font-weight:600;
      background: var(--accent);
      color:#fff;
      transition: .25s ease;
      font-size:.9rem;
    }
    .btn-secondary {
      background: rgba(255,255,255,.07);
      color: var(--text);
    }
    .btn:hover:not(.disabled) {filter:brightness(1.08); transform:translateY(-1px);}
    .input {
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.1);
      padding:.7rem 1rem;
      border-radius:8px;
      width:100%;
      font-size:.9rem;
      color: var(--text);
      outline:none;
      transition: .2s ease;
      resize:vertical;
    }
    .input:focus {
      border-color: #a399ff;
      box-shadow:0 0 16px rgba(99,102,241,.4);
      background: rgba(255,255,255,.06);
    }
    .pill {
      background: rgba(255,255,255,.08);
      padding:6px 12px;
      border-radius:999px;
      font-size:.65rem;
      display:inline-block;
      margin-right:6px;
      margin-bottom:4px;
    }
    .template-switcher {display:flex; gap:8px; margin-bottom:1rem; flex-wrap:wrap;}
    .template-card {
      flex:1;
      background: rgba(255,255,255,.03);
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
      position:relative;
      border:2px solid transparent;
      transition:.25s;
      min-width:130px;
      display:flex;
      align-items:center;
      gap:12px;
      font-size:.8rem;
      user-select:none;
    }
    .template-card.selected {
      border-color: #fff;
      box-shadow:0 25px 70px -10px rgba(99,102,241,.6);
      background: linear-gradient(135deg,#4f46e5,#6366f1);
      color:#fff;
    }
    .section-wrapper {
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:14px 16px;
      margin-bottom:1rem;
      background: rgba(255,255,255,.01);
      transition:.3s;
    }
    .section-wrapper:hover {box-shadow:0 20px 55px -10px rgba(99,102,241,.2);}
    .section-title {
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
      font-weight:600;
      font-size:.85rem;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .line {width:38px; height:4px; background: var(--accent); border-radius:3px; flex-shrink:0;}
    .small-btn {
      background: rgba(255,255,255,.06);
      border:none;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:.75rem;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.2s;
    }
    .small-btn:hover {background: rgba(255,255,255,.12);}
    .preview-wrapper {
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      border-radius:14px;
      padding:16px;
      position:sticky;
      top:16px;
      overflow:auto;
      min-height:720px;
      max-height:calc(100vh - 32px);
    }
    .notification {
      position:fixed;
      top:16px;
      right:16px;
      background:rgba(99,102,241,.95);
      color:#fff;
      padding:12px 18px;
      border-radius:8px;
      box-shadow:0 30px 60px -10px rgba(99,102,241,.5);
      display:flex;
      gap:8px;
      align-items:center;
      font-size:.9rem;
      z-index:100;
      opacity:0;
      pointer-events:none;
      transition:.3s;
    }
    .notification.show {opacity:1; pointer-events:auto;}
    .theme-toggle {
      background: rgba(255,255,255,.07);
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:.8rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color: var(--text);
      margin-left:auto;
      transition:.25s;
    }
    .theme-toggle:hover {background: rgba(255,255,255,.12);}
    .skill-badge {
      display:inline-block;
      background:#eef2f7;
      color:#444;
      padding:6px 14px;
      border-radius:999px;
      font-size:.65rem;
      margin:2px 4px 4px 0;
    }

    /* === Резюме === */
    .resume-container {width:100%; display:flex; justify-content:center;}
    .resume {
      background:#fff;
      color:#1e2432;
      border-radius:10px;
      padding:28px 32px;
      width:800px;
      margin:auto;
      position:relative;
      overflow:hidden;
      font-size:14px;
      line-height:1.3;
      box-shadow:0 40px 90px -20px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
    }
    .resume *{box-sizing:border-box;}
    .resume .photo {
      width:100px;
      height:100px;
      border-radius:50%;
      object-fit:cover;
      border:3px solid var(--accent);
      margin-right:14px;
      flex-shrink:0;
    }
    .resume-header {
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .name-block h1 {
      margin:0;
      font-size:2rem;
      line-height:1.1;
      font-weight:700;
    }
    .title {
      margin-top:4px;
      font-weight:600;
      color:#555;
      font-size:.9rem;
    }
    .contact {
      text-align:right;
      font-size:.65rem;
      line-height:1.3;
      flex:1;
    }
    .muted {color:#777;}
    .item {margin-bottom:14px;}
    a {color:inherit; text-decoration:underline;}

    /* шаблоны */
    /* Classic */
    .tpl-classic .resume {
      display:grid;
      grid-template-columns:220px 1fr;
      gap:32px;
      padding:24px 32px;
    }
    .tpl-classic .sidebar {
      background: var(--accent);
      color:#fff;
      padding:20px 18px;
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .tpl-classic .sidebar .title {color:rgba(255,255,255,.9);}
    .tpl-classic .sidebar .skill-badge{
      background:rgba(255,255,255,.2);
      color:#fff;
      display:block;
      margin-bottom:6px;
    }
    .tpl-classic .section-title .line {background:#fff;}

    /* Modern */
    .tpl-modern .resume {
      position:relative;
      padding-top:18px;
      border:2px solid var(--accent);
      border-radius:12px;
    }
    .tpl-modern .resume::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:10px;
      background: var(--accent);
      border-radius:6px 6px 0 0;
    }
    .tpl-modern .section-title .line {background: var(--accent);}
    .tpl-modern .name-block h1 {font-size:2.1rem;}

    /* Elegant */
    .tpl-elegant .resume {
      font-family:'Merriweather',serif;
      background:#f9f8f6;
      padding:34px 36px;
      color:#2e2e34;
      border:1px solid #e7e5e2;
    }
    .tpl-elegant h1 {
      font-family:'Merriweather',serif;
      font-size:2.2rem;
      margin:0;
    }
    .tpl-elegant .title {color:#555; margin-top:4px; font-weight:500;}
    .tpl-elegant .section-title .line {background:#444;}
    .tpl-elegant .skill-badge {background:#e6e2dd; color:#3f3f46;}

    /* Creative Dark */
    .tpl-creative-dark .resume {
      background:#0f1025;
      color:#f0f2fa;
      padding:30px 32px;
      border-radius:14px;
      position:relative;
    }
    .tpl-creative-dark .resume::after {
      content:'';
      position:absolute;
      bottom:0;
      right:0;
      width:160px;
      height:160px;
      background:rgba(255,255,255,.03);
      border-radius:50%;
      filter:blur(40px);
    }
    .tpl-creative-dark h1 {color:#fff;}
    .tpl-creative-dark .title {color:#d1d5fa;}
    .tpl-creative-dark .section-title .line {background: var(--accent);}
    .tpl-creative-dark .skill-badge {background:rgba(255,255,255,.1); color:#fff;}

    /* Creative Light */
    .tpl-creative-light .resume {
      background:#fdfdfd;
      color:#1f2235;
      padding:30px 32px;
      border-radius:14px;
      position:relative;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    }
    .tpl-creative-light .resume::after {
      content:'';
      position:absolute;
      top:10px;
      left:10px;
      width:120px;
      height:120px;
      border:3px dashed var(--accent);
      border-radius:50%;
      opacity:.15;
    }
    .tpl-creative-light h1 {color: var(--accent);}
    .tpl-creative-light .section-title .line {background: var(--accent);}
    .tpl-creative-light .skill-badge {background:#eef0f5; color:#444;}

    /* Responsive */
    @media (max-width:1250px){
      .app{grid-template-columns:1fr;}
      .preview-wrapper{position:relative; top:auto; max-height:none;}
      .resume{width:100%;}
    }
  </style>
</head>
<body>
  <div id="notif" class="notification" aria-live="polite"></div>

  <div class="app">
    <!-- Редактор -->
    <div class="panel" aria-label="Редактор">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <h1 style="margin-bottom:4px;">Резюме</h1>
          <div style="display:flex; gap:6px; flex-wrap:wrap; font-size:.75rem;">
            <div class="pill">Telegram-ready</div>
            <div class="pill">PDF export</div>
            <div class="pill">LocalStorage</div>
          </div>
        </div>
        <button class="theme-toggle" id="telegram-ready">📦 Telegram</button>
      </div>

      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <div style="flex:1; min-width:250px;">
          <div class="template-switcher" aria-label="Выбор шаблона">
            <div class="template-card selected" data-template="classic">
              <div class="info"><strong>Classic</strong><div style="font-size:.6rem;">Боковая панель</div></div>
            </div>
            <div class="template-card" data-template="modern">
              <div class="info"><strong>Modern</strong><div style="font-size:.6rem;">Верхняя полоса</div></div>
            </div>
            <div class="template-card" data-template="elegant">
              <div class="info"><strong>Elegant</strong><div style="font-size:.6rem;">Serif</div></div>
            </div>
            <div class="template-card" data-template="creative-dark">
              <div class="info"><strong>Creative Dark</strong><div style="font-size:.6rem;">Арт</div></div>
            </div>
            <div class="template-card" data-template="creative-light">
              <div class="info"><strong>Creative Light</strong><div style="font-size:.6rem;">Пастель</div></div>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="section-title" style="margin:0;">
              <div class="line" style="margin-right:6px;"></div><div style="font-size:.75rem;">Цвет акцента</div>
            </div>
            <input type="color" id="accent-picker" value="#6366f1" style="border:none; width:36px; height:36px; border-radius:6px; cursor:pointer;" />
          </div>
          <div style="font-size:.75rem; color:rgba(255,255,255,.75);">Шаблон: <strong id="template-display">Classic</strong></div>
        </div>
      </div>

      <!-- Профиль -->
      <div class="section-wrapper" data-step="0">
        <div class="section-title">
          <div class="line"></div><div>Профиль</div>
        </div>
        <div class="flex" style="gap:16px; flex-wrap:wrap;">
          <div style="flex:2; min-width:200px;">
            <div class="flex" style="gap:14px; flex-wrap:wrap;">
              <div style="flex:1; min-width:140px;">
                <small>Имя и фамилия</small>
                <input class="input" type="text" id="fullName" placeholder="Иван Иванов" />
              </div>
              <div style="flex:1; min-width:140px;">
                <small>Должность</small>
                <input class="input" type="text" id="title" placeholder="Frontend разработчик" />
              </div>
            </div>
            <div class="flex" style="gap:14px; flex-wrap:wrap; margin-top:6px;">
              <div style="flex:1; min-width:140px;">
                <small>Email</small>
                <input class="input" type="email" id="email" placeholder="ivan@example.com" />
              </div>
              <div style="flex:1; min-width:140px;">
                <small>Телефон</small>
                <input class="input" type="text" id="phone" placeholder="+7 912 345-67-89" />
              </div>
            </div>
          </div>
          <div style="flex:1; min-width:140px;">
            <small>Фото</small>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <div style="position:relative; width:100px; height:100px; flex-shrink:0;">
                <img id="photo-preview" src="" alt="Фото" style="width:100%; height:100%; object-fit:cover; border-radius:50%; border:2px solid var(--accent); background:rgba(255,255,255,.05);" />
              </div>
              <div style="flex:1; min-width:120px;">
                <input type="file" id="photo-input" accept="image/*" style="width:100%;" />
                <div style="font-size:.6rem; margin-top:4px;">Макс 2MB</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- О себе -->
      <div class="section-wrapper" data-step="1">
        <div class="section-title">
          <div class="line"></div><div>О себе</div>
        </div>
        <textarea class="input" id="summary" rows="3" placeholder="Краткое описание себя..."></textarea>
      </div>

      <!-- Опыт -->
      <div class="section-wrapper" data-step="2">
        <div class="section-title">
          <div class="line"></div><div>Опыт работы</div>
        </div>
        <div id="experience-list"></div>
        <div style="margin-top:6px;">
          <button class="small-btn" id="add-experience">+ Добавить опыт</button>
        </div>
      </div>

      <!-- Образование и навыки -->
      <div class="section-wrapper" data-step="3">
        <div class="section-title">
          <div class="line"></div><div>Образование</div>
        </div>
        <div id="education-list"></div>
        <div style="margin-top:6px;">
          <button class="small-btn" id="add-education">+ Добавить образование</button>
        </div>

        <div style="margin-top:18px;">
          <div class="section-title">
            <div class="line"></div><div>Навыки</div>
          </div>
          <div id="skills-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
          <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
            <input class="input" id="new-skill" placeholder="JavaScript" style="flex:1; min-width:140px;" />
            <button class="small-btn" id="add-skill">Добавить</button>
          </div>
        </div>
      </div>

      <!-- Проекты -->
      <div class="section-wrapper" data-step="4">
        <div class="section-title">
          <div class="line"></div><div>Проекты</div>
        </div>
        <div id="projects-list"></div>
        <div style="margin-top:6px;">
          <button class="small-btn" id="add-project">+ Добавить проект</button>
        </div>
      </div>

      <!-- Управление -->
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="save-btn">Сохранить</button>
          <button class="btn btn-secondary" id="load-btn">Загрузить</button>
          <button class="btn btn-secondary" id="reset-btn">Сбросить</button>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="preview-btn">Открыть превью</button>
          <button class="btn" id="export-pdf-btn">Экспорт в PDF</button>
        </div>
      </div>

      <div style="margin-top:6px; font-size:.65rem; color:rgba(255,255,255,.7);">
        Данные сохраняются локально. Можно отправить JSON в Telegram WebApp.
      </div>
    </div>

    <!-- Превью -->
    <div class="panel" aria-label="Превью">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="flex:1;">
          <h2 style="margin:0;">Превью</h2>
          <div style="font-size:.75rem; color: var(--muted);">Живое отображение</div>
        </div>
        <div>
          <div class="pill">Шаблон: <strong id="template-badge">Classic</strong></div>
        </div>
      </div>
      <div class="preview-wrapper" id="preview-container">
        <div id="resume-render" class="resume tpl-classic"></div>
      </div>
    </div>
  </div>

  <script>
    // Утилиты
    function uuid(){return crypto.randomUUID?.()||Math.random().toString(36).substring(2,9);}
    function showNotification(msg,d=1600){
      const n=document.getElementById('notif');
      n.textContent=msg;
      n.classList.add('show');
      setTimeout(()=>n.classList.remove('show'),d);
    }
    function debounce(fn,ms=200){
      let t;
      return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);};
    }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    function defaultData(){
      return {
        profile:{fullName:'',title:'',email:'',phone:''},
        photo:'',
        summary:'',
        experience:[],
        education:[],
        skills:[],
        projects:[],
        template:'classic',
        accent:'#6366f1'
      };
    }
    function saveData(d){localStorage.setItem('resume_builder_data',JSON.stringify(d));}
    function loadData(){try{return JSON.parse(localStorage.getItem('resume_builder_data'))||defaultData();}catch{return defaultData();}}

    // State
    let state=loadData();

    // Elements
    const fullNameEl=document.getElementById('fullName');
    const titleEl=document.getElementById('title');
    const emailEl=document.getElementById('email');
    const phoneEl=document.getElementById('phone');
    const summaryEl=document.getElementById('summary');
    const experienceListEl=document.getElementById('experience-list');
    const educationListEl=document.getElementById('education-list');
    const skillsListEl=document.getElementById('skills-list');
    const projectsListEl=document.getElementById('projects-list');
    const resumeRenderEl=document.getElementById('resume-render');
    const templateDisplay=document.getElementById('template-display');
    const templateBadge=document.getElementById('template-badge');
    const accentPicker=document.getElementById('accent-picker');
    const photoInput=document.getElementById('photo-input');
    const photoPreview=document.getElementById('photo-preview');

    function niceTemplate(t){
      if(t==='modern')return 'Modern';
      if(t==='elegant')return 'Elegant';
      if(t==='creative-dark')return 'Creative Dark';
      if(t==='creative-light')return 'Creative Light';
      return 'Classic';
    }

    // Initialization
    function init(){
      // restore accent
      if(state.accent)document.documentElement.style.setProperty('--accent',state.accent);
      accentPicker.value=state.accent||getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      bind();
      populateForm();
      renderDynamicSections();
      renderPreview();
      applyTemplateSelection();
      updateStepper();
    }

    function bind(){
      const syncProfile=debounce(()=>{
        state.profile.fullName=fullNameEl.value;
        state.profile.title=titleEl.value;
        state.profile.email=emailEl.value;
        state.profile.phone=phoneEl.value;
        persist();
        renderPreview();
        updateStepper();
      },250);
      [fullNameEl,titleEl,emailEl,phoneEl].forEach(i=>i.addEventListener('input',syncProfile));
      summaryEl.addEventListener('input',debounce(()=>{
        state.summary=summaryEl.value; persist(); renderPreview(); updateStepper();
      },300));

      document.getElementById('add-experience').addEventListener('click',()=>{
        state.experience.push({id:uuid(),company:'',position:'',start:'',end:'',description:''});
        persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Добавлен опыт');
      });
      document.getElementById('add-education').addEventListener('click',()=>{
        state.education.push({id:uuid(),school:'',degree:'',start:'',end:'',extra:''});
        persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Добавлено образование');
      });
      document.getElementById('add-skill').addEventListener('click',()=>{
        const v=document.getElementById('new-skill').value.trim();
        if(v){
          if(!state.skills.includes(v)){
            state.skills.push(v);
            persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Навык добавлен');
          } else showNotification('Уже есть');
          document.getElementById('new-skill').value='';
        }
      });
      document.getElementById('add-project').addEventListener('click',()=>{
        state.projects.push({id:uuid(),name:'',description:'',link:''});
        persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Добавлен проект');
      });

      document.getElementById('save-btn').addEventListener('click',()=>{
        persist(); showNotification('Сохранено');
      });
      document.getElementById('load-btn').addEventListener('click',()=>{
        state=loadData();
        if(state.accent)document.documentElement.style.setProperty('--accent',state.accent);
        populateForm(); renderDynamicSections(); renderPreview(); applyTemplateSelection(); updateStepper();
        showNotification('Загружено');
      });
      document.getElementById('reset-btn').addEventListener('click',()=>{
        if(!confirm('Очистить всё?'))return;
        state=defaultData();
        persist();
        document.documentElement.style.setProperty('--accent',state.accent);
        accentPicker.value=state.accent;
        populateForm(); renderDynamicSections(); renderPreview(); applyTemplateSelection(); updateStepper();
        showNotification('Сброшено');
      });

      document.querySelectorAll('.template-card').forEach(c=>{
        c.addEventListener('click',()=>{
          const tpl=c.getAttribute('data-template');
          state.template=tpl;
          persist();
          applyTemplateSelection();
          renderPreview();
          templateDisplay.textContent=niceTemplate(tpl);
          templateBadge.textContent=niceTemplate(tpl);
          showNotification('Шаблон: '+niceTemplate(tpl));
        });
      });

      accentPicker.addEventListener('input',e=>{
        const c=e.target.value;
        document.documentElement.style.setProperty('--accent',c);
        state.accent=c;
        persist();
        renderPreview();
      });

      photoInput.addEventListener('change',e=>{
        const file=e.target.files[0];
        if(!file) return;
        if(file.size > 2*1024*1024){ showNotification('Файл слишком большой'); return; }
        const r=new FileReader();
        r.onload=()=>{ state.photo=r.result; photoPreview.src=r.result; persist(); renderPreview(); };
        r.readAsDataURL(file);
      });

      document.getElementById('preview-btn').addEventListener('click',()=>{ renderPreview(true); });
      document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);

      if(window.Telegram?.WebApp){
        window.Telegram.WebApp.ready();
        const tbtn=document.getElementById('telegram-ready');
        tbtn.textContent='Telegram ✔';
        tbtn.addEventListener('click',()=>{
          window.Telegram.WebApp.sendData(JSON.stringify({resume:state}));
          showNotification('Отправлено');
        });
      }
    }

    function persist(){ saveData(state); }

    function populateForm(){
      fullNameEl.value=state.profile.fullName;
      titleEl.value=state.profile.title;
      emailEl.value=state.profile.email;
      phoneEl.value=state.profile.phone;
      summaryEl.value=state.summary;
      templateDisplay.textContent=niceTemplate(state.template);
      templateBadge.textContent=niceTemplate(state.template);
      if(state.photo){
        photoPreview.src=state.photo;
      } else {
        photoPreview.src='';
        photoPreview.style.background='rgba(255,255,255,.05)';
      }
    }

    function applyTemplateSelection(){
      document.querySelectorAll('.template-card').forEach(c=>{
        c.classList.toggle('selected', c.getAttribute('data-template')===state.template);
      });
    }

    function renderDynamicSections(){
      // Опыт
      experienceListEl.innerHTML='';
      state.experience.forEach(exp=>{
        const w=document.createElement('div');
        w.className='section-wrapper';
        w.dataset.id=exp.id;
        w.innerHTML=`
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="section-title"><div class="line"></div><div>Опыт</div></div>
            <div><button class="small-btn remove-exp">Удалить</button></div>
          </div>
          <div class="flex" style="gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:120px;">
              <small>Компания</small>
              <input class="input exp-company" value="${escapeHtml(exp.company)}" placeholder="Acme Corp" />
            </div>
            <div style="flex:1; min-width:120px;">
              <small>Должность</small>
              <input class="input exp-position" value="${escapeHtml(exp.position)}" placeholder="Frontend dev" />
            </div>
          </div>
          <div class="flex" style="gap:12px; flex-wrap:wrap; margin-top:6px;">
            <div style="flex:1; min-width:120px;">
              <small>С</small>
              <input class="input exp-start" type="month" value="${exp.start}" />
            </div>
            <div style="flex:1; min-width:120px;">
              <small>По</small>
              <input class="input exp-end" type="month" value="${exp.end}" />
            </div>
          </div>
          <div style="margin-top:6px;">
            <small>Описание</small>
            <textarea class="input exp-desc" rows="2" placeholder="Что делали...">${escapeHtml(exp.description)}</textarea>
          </div>
        `;
        experienceListEl.appendChild(w);
        w.querySelector('.exp-company').addEventListener('input',e=>{ exp.company=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.exp-position').addEventListener('input',e=>{ exp.position=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.exp-start').addEventListener('input',e=>{ exp.start=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.exp-end').addEventListener('input',e=>{ exp.end=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.exp-desc').addEventListener('input',e=>{ exp.description=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.remove-exp').addEventListener('click',()=>{
          state.experience=state.experience.filter(x=>x.id!==exp.id);
          persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Опыт удалён');
        });
      });

      // Образование
      educationListEl.innerHTML='';
      state.education.forEach(ed=>{
        const w=document.createElement('div');
        w.className='section-wrapper';
        w.dataset.id=ed.id;
        w.innerHTML=`
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="section-title"><div class="line"></div><div>Образование</div></div>
            <div><button class="small-btn remove-edu">Удалить</button></div>
          </div>
          <div class="flex" style="gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:140px;">
              <small>Учебное заведение</small>
              <input class="input edu-school" value="${escapeHtml(ed.school)}" placeholder="Университет" />
            </div>
            <div style="flex:1; min-width:140px;">
              <small>Степень</small>
              <input class="input edu-degree" value="${escapeHtml(ed.degree)}" placeholder="Бакалавр" />
            </div>
          </div>
          <div class="flex" style="gap:12px; flex-wrap:wrap; margin-top:6px;">
            <div style="flex:1; min-width:120px;">
              <small>С</small>
              <input class="input edu-start" type="month" value="${ed.start}" />
            </div>
            <div style="flex:1; min-width:120px;">
              <small>По</small>
              <input class="input edu-end" type="month" value="${ed.end}" />
            </div>
          </div>
          <div style="margin-top:6px;">
            <small>Дополнительно</small>
            <input class="input edu-extra" value="${escapeHtml(ed.extra)}" placeholder="GPA и т.п." />
          </div>
        `;
        educationListEl.appendChild(w);
        w.querySelector('.edu-school').addEventListener('input',e=>{ ed.school=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.edu-degree').addEventListener('input',e=>{ ed.degree=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.edu-start').addEventListener('input',e=>{ ed.start=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.edu-end').addEventListener('input',e=>{ ed.end=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.edu-extra').addEventListener('input',e=>{ ed.extra=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.remove-edu').addEventListener('click',()=>{
          state.education=state.education.filter(x=>x.id!==ed.id);
          persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Образование удалено');
        });
      });

      // Навыки
      skillsListEl.innerHTML='';
      state.skills.forEach(s=>{
        const badge=document.createElement('div');
        badge.className='skill-badge';
        badge.textContent=s;
        const rem=document.createElement('span');
        rem.style.marginLeft='6px';
        rem.style.cursor='pointer';
        rem.textContent='×';
        rem.title='Удалить';
        rem.addEventListener('click',()=>{
          state.skills=state.skills.filter(x=>x!==s);
          persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Навык удалён');
        });
        badge.appendChild(rem);
        skillsListEl.appendChild(badge);
      });

      // Проекты
      projectsListEl.innerHTML='';
      state.projects.forEach(p=>{
        const w=document.createElement('div');
        w.className='section-wrapper';
        w.dataset.id=p.id;
        w.innerHTML=`
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="section-title"><div class="line"></div><div>Проект</div></div>
            <div><button class="small-btn remove-proj">Удалить</button></div>
          </div>
          <div>
            <small>Название</small>
            <input class="input proj-name" value="${escapeHtml(p.name)}" placeholder="Название проекта" />
          </div>
          <div style="margin-top:6px;">
            <small>Описание</small>
            <textarea class="input proj-desc" rows="2" placeholder="Что делает...">${escapeHtml(p.description)}</textarea>
          </div>
          <div style="margin-top:6px;">
            <small>Ссылка</small>
            <input class="input proj-link" value="${escapeHtml(p.link)}" placeholder="https://..." />
          </div>
        `;
        projectsListEl.appendChild(w);
        w.querySelector('.proj-name').addEventListener('input',e=>{ p.name=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.proj-desc').addEventListener('input',e=>{ p.description=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.proj-link').addEventListener('input',e=>{ p.link=e.target.value; persist(); renderPreview(); updateStepper(); });
        w.querySelector('.remove-proj').addEventListener('click',()=>{
          state.projects=state.projects.filter(x=>x.id!==p.id);
          persist(); renderDynamicSections(); renderPreview(); updateStepper(); showNotification('Проект удалён');
        });
      });
    }

    function updateStepper(){
      let filled=0;
      if(state.profile.fullName||state.profile.title||state.profile.email||state.profile.phone) filled++;
      if(state.summary) filled++;
      if(state.experience.length) filled++;
      if(state.education.length||state.skills.length) filled++;
      if(state.projects.length) filled++;
      document.querySelectorAll('.step-dot').forEach((d,i)=>{
        d.classList.toggle('active', i<filled);
      });
    }

    function buildResumeHTML(data){
      function fmt(start,end){
        if(!start&&!end) return '';
        const opts={year:'numeric',month:'short'};
        try{
          const s = start? new Date(start+'-01').toLocaleDateString('ru-RU',opts):'';
          const e = end? new Date(end+'-01').toLocaleDateString('ru-RU',opts):'настоящее время';
          return `${s} — ${e}`;
        }catch{ return `${start||''} — ${end||''}`;}
      }

      let expHTML='';
      data.experience.forEach(exp=>{
        if(!exp.company&&!exp.position) return;
        expHTML+=`
          <div class="item">
            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:6px;">
              <div>
                <div style="font-weight:600;">${escapeHtml(exp.position||'')} ${exp.position&&exp.company?'в':''} ${escapeHtml(exp.company||'')}</div>
                <div class="muted" style="font-size:.7rem;">${fmt(exp.start,exp.end)}</div>
              </div>
            </div>
            <div style="margin-top:6px;">${escapeHtml(exp.description||'')}</div>
          </div>
        `;
      });

      let eduHTML='';
      data.education.forEach(ed=>{
        if(!ed.school) return;
        eduHTML+=`
          <div class="item">
            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:6px;">
              <div>
                <div style="font-weight:600;">${escapeHtml(ed.degree||'')} — ${escapeHtml(ed.school||'')}</div>
                <div class="muted" style="font-size:.7rem;">${fmt(ed.start,ed.end)}</div>
              </div>
            </div>
            ${ed.extra?`<div style="margin-top:5px;">${escapeHtml(ed.extra)}</div>`:''}
          </div>
        `;
      });

      let skillsHTML='';
      data.skills.forEach(s=>{
        skillsHTML+=`<div class="skill-badge">${escapeHtml(s)}</div>`;
      });

      let projHTML='';
      data.projects.forEach(p=>{
        if(!p.name) return;
        projHTML+=`
          <div class="item">
            <div style="font-weight:600;">${escapeHtml(p.name)}</div>
            <div style="margin-top:4px;">${escapeHtml(p.description)}</div>
            ${p.link?`<div style="margin-top:4px;"><a href="${escapeHtml(p.link)}" target="_blank">${escapeHtml(p.link)}</a></div>`:''}
          </div>
        `;
      });

      // вертикальный базовый
      const vertical = `
        <div class="resume">
          <div class="resume-header" style="display:flex; gap:16px; flex-wrap:wrap;">
            <div style="display:flex; gap:14px; align-items:center; flex:1; min-width:250px;">
              ${data.photo?`<img src="${data.photo}" alt="Фото" class="photo" />`:`<div style="width:100px;height:100px;border-radius:50%;background:rgba(200,200,200,.15);margin-right:14px;flex-shrink:0;"></div>`}
              <div>
                <h1>${escapeHtml(data.profile.fullName||'Ваше имя')}</h1>
                <div class="title">${escapeHtml(data.profile.title||'')}</div>
              </div>
            </div>
            <div class="contact" style="min-width:140px;">
              <div>${escapeHtml(data.profile.email||'')}</div>
              <div>${escapeHtml(data.profile.phone||'')}</div>
            </div>
          </div>

          ${data.summary?`
            <div style="margin-top:18px;">
              <div class="section-title">
                <div class="line"></div><div>О себе</div>
              </div>
              <div class="item">${escapeHtml(data.summary)}</div>
            </div>`:''}

          ${expHTML?`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Опыт работы</div>
              </div>
              ${expHTML}
            </div>`:''}

          ${eduHTML?`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Образование</div>
              </div>
              ${eduHTML}
            </div>`:''}

          ${skillsHTML?`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Навыки</div>
              </div>
              <div style="display:flex; flex-wrap:wrap; gap:6px;">${skillsHTML}</div>
            </div>`:''}

          ${projHTML?`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Проекты</div>
              </div>
              ${projHTML}
            </div>`:''}
        </div>
      `;

      // classic sidebar версия
      if(data.template==='classic'){
        const sidebar=`
          <div class="sidebar">
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:6px; flex-wrap:wrap;">
              ${data.photo?`<img src="${data.photo}" alt="Фото" class="photo" style="width:80px;height:80px;border:2px solid #fff;" />`:`<div style="width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.2);margin-right:8px;"></div>`}
              <div>
                <div style="font-size:1.4rem; font-weight:700;">${escapeHtml(data.profile.fullName||'')}</div>
                <div style="margin-top:4px;">${escapeHtml(data.profile.title||'')}</div>
              </div>
            </div>
            <div style="margin-top:12px;">
              <div style="font-weight:600; margin-bottom:4px; font-size:.75rem;">Контакты</div>
              <div style="font-size:.8rem;">${escapeHtml(data.profile.email||'')}</div>
              <div style="font-size:.8rem;">${escapeHtml(data.profile.phone||'')}</div>
            </div>
            ${data.skills.length?`
              <div style="margin-top:16px;">
                <div style="font-weight:600; margin-bottom:6px; font-size:.75rem;">Навыки</div>
                ${data.skills.map(s=>`<div style="font-size:.75rem; margin-bottom:4px;">${escapeHtml(s)}</div>`).join('')}
              </div>`:''}
          </div>
        `;
        let main='';
        if(data.summary){
          main+=`
            <div>
              <div class="section-title">
                <div class="line"></div><div>О себе</div>
              </div>
              <div class="item">${escapeHtml(data.summary)}</div>
            </div>`;
        }
        if(expHTML){
          main+=`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Опыт работы</div>
              </div>
              ${expHTML}
            </div>`;
        }
        if(eduHTML){
          main+=`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Образование</div>
              </div>
              ${eduHTML}
            </div>`;
        }
        if(projHTML){
          main+=`
            <div>
              <div class="section-title">
                <div class="line"></div><div>Проекты</div>
              </div>
              ${projHTML}
            </div>`;
        }
        return `
          <div class="resume">
            ${sidebar}
            <div class="main-content">
              ${main}
            </div>
          </div>
        `;
      }

      // остальные шаблоны
      return vertical;
    }

    function renderPreview(openWindow=false){
      const container=document.getElementById('resume-render');
      // сброс классов
      container.className='resume';
      // применяем шаблонный класс
      let tplClass='tpl-classic';
      if(state.template==='modern') tplClass='tpl-modern';
      else if(state.template==='elegant') tplClass='tpl-elegant';
      else if(state.template==='creative-dark') tplClass='tpl-creative-dark';
      else if(state.template==='creative-light') tplClass='tpl-creative-light';
      container.classList.add(tplClass);
      // innerHTML
      container.innerHTML=buildResumeHTML(state);
      // бейджи
      document.getElementById('template-display').textContent=niceTemplate(state.template);
      templateBadge.textContent=niceTemplate(state.template);
      // если открывать отдельное окно
      if(openWindow){
        const w=window.open('');
        const html = container.outerHTML;
        w.document.write(`
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>Превью резюме</title>
              <meta name="viewport" content="width=device-width,initial-scale=1.0" />
              <style>
                body{margin:0;padding:30px;background:#f2f4f9;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;}
                .resume{max-width:800px;margin:auto;}
                h1{margin:0;font-size:1.9rem;}
                .muted{color:#777;}
                .skill-badge{display:inline-block;background:#eef2f7;color:#444;padding:6px 14px;border-radius:999px;font-size:.65rem;margin:2px 4px 4px 0;}
                a{color:#6366f1;text-decoration:none;}
              </style>
            </head>
            <body>${html}</body>
          </html>
        `);
        w.document.close();
      }
    }

    // PDF экспорт (высокое качество)
    async function exportPDF(){
      const resumeNode=document.querySelector('#resume-render .resume');
      if(!resumeNode){ showNotification('Нет контента'); return; }
      showNotification('Генерирую PDF...',2200);
      try{
        if(document.fonts && document.fonts.ready) await document.fonts.ready;
        // клонируем
        const clone=resumeNode.cloneNode(true);
        clone.style.transform='none';
        clone.style.boxShadow='none';
        clone.style.margin='0';
        clone.style.width='800px';

        const wrapper=document.createElement('div');
        wrapper.style.position='fixed';
        wrapper.style.top='-9999px';
        wrapper.style.left='-9999px';
        wrapper.style.background='#fff';
        wrapper.appendChild(clone);
        document.body.appendChild(wrapper);

        const canvas=await html2canvas(clone,{
          scale:3,
          useCORS:true,
          backgroundColor:'#ffffff',
          logging:false
        });
        document.body.removeChild(wrapper);
        const imgData=canvas.toDataURL('image/png');

        const { jsPDF }=window.jspdf;
        const pdf=new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
        const pageWidth=pdf.internal.pageSize.getWidth();
        const pageHeight=pdf.internal.pageSize.getHeight();
        const margin=35;
        const ratio=Math.min((pageWidth-margin*2)/canvas.width,(pageHeight-margin*2)/canvas.height);
        const imgW=canvas.width*ratio;
        const imgH=canvas.height*ratio;

        pdf.addImage(imgData,'PNG',(pageWidth-imgW)/2,40,imgW,imgH);
        const filename=(state.profile.fullName||'resume').trim().replace(/\s+/g,'_')+'.pdf';
        pdf.save(filename);
        showNotification('PDF готов');
      }catch(e){
        console.error(e);
        showNotification('Ошибка экспорта');
      }
    }

    // Степпер
    function updateStepper(){
      let filled=0;
      if(state.profile.fullName||state.profile.title||state.profile.email||state.profile.phone) filled++;
      if(state.summary) filled++;
      if(state.experience.length) filled++;
      if(state.education.length||state.skills.length) filled++;
      if(state.projects.length) filled++;
      document.querySelectorAll('.step-dot').forEach((d,i)=>{
        d.classList.toggle('active', i<filled);
      });
    }

    // Инициализация
    init();
    // Обновление прогресса периодически (если изменилось вне обработчиков)
    setInterval(updateStepper,800);
  </script>
</body>
</html>
